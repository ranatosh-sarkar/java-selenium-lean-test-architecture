name: Test & Publish Allure to GitHub Pages

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Ensure Chrome is present
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Show Chrome version
        run: |
          echo "Chrome: ${CHROME_PATH:-$CHROME_BIN}"
          "${CHROME_PATH:-$CHROME_BIN}" --version

      - name: Cache Maven repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            m2-${{ runner.os }}-

      - name: Clean previous raw Allure results
        working-directory: selenium
        run: |
          rm -rf allure-results
          mkdir -p allure-results

      - name: Run tests (writes RAW to allure-results/)
        working-directory: selenium
        run: mvn -B -DskipTests=false test

      - name: Generate Allure HTML (selenium/reports/allure-report-<ts>/)
        working-directory: selenium
        run: mvn -B io.qameta.allure:allure-maven:2.12.0:report

      - name: Collect HTML into repo-root /public
        run: |
          set -e
          RUN_ID="${{ github.run_number }}"
          REPORT_DIR="$(ls -td selenium/reports/allure-report-* | head -1)"
          echo "Latest HTML report: $REPORT_DIR"

          mkdir -p public/runs/"$RUN_ID"
          cp -r "$REPORT_DIR"/* "public/runs/$RUN_ID/"

          # Latest redirect
          mkdir -p public/latest
          echo '<!doctype html><meta http-equiv="refresh" content="0; url=../runs/'"$RUN_ID"'/index.html">' > public/latest/index.html

          # Simple index of all runs
          {
            echo '<!doctype html><html><head><meta charset="utf-8"><title>Allure Runs</title>'
            echo '<style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:2rem} a{color:#0a58ca;text-decoration:none} li{margin:.4rem 0}</style></head><body>'
            echo '<h1>Allure Reports</h1>'
            echo '<p><a href="latest/">Latest report</a></p>'
            echo '<h2>History</h2><ul>'
            for d in $(ls -td public/runs/* 2>/dev/null | sed 's|public/||'); do
              n=$(basename "$d")
              echo "<li><a href=\"$d/index.html\">Run #$n</a></li>"
            done
            echo '</ul></body></html>'
          } > public/index.html

      - name: Upload Pages artifact (public/)
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
