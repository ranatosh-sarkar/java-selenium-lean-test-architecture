stages: [build, pages]

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  ALLURE_VERSION: "2.29.0"

# 1) Build tests + generate Allure HTML
build-allure:
  stage: build
  image: maven:3.9.9-eclipse-temurin-17
  script:
    # Run tests (Surefire writes RAW to allure-results thanks to POM)
    - mvn -B -DskipTests=false test

    # Build Allure HTML (POM allure-maven plugin reads allure-results and outputs reports/allure-report-<timestamp>)
    - mvn -B io.qameta.allure:allure-maven:2.12.0:report

    # Find most-recent Allure HTML folder
    - REPORT_DIR=$(ls -td reports/allure-report-* | head -1)
    - echo "Found Allure report: $REPORT_DIR"

    # Prepare GitLab Pages structure
    - mkdir -p public
    - RUN_DIR="public/runs/${CI_PIPELINE_ID}"
    - mkdir -p "$RUN_DIR"

    # Copy this run’s report into its own folder
    - cp -r "$REPORT_DIR"/* "$RUN_DIR/"

    # Update /latest redirect (use a tiny HTML redirect instead of symlink to be Pages-friendly)
    - mkdir -p public/latest
    - |
      cat > public/latest/index.html <<EOF
      <!doctype html>
      <meta charset="utf-8">
      <meta http-equiv="refresh" content="0; url=/-/project/${CI_PROJECT_PATH}/-/jobs/${CI_JOB_ID}/artifacts/file/runs/${CI_PIPELINE_ID}/index.html">
      <script>location.href="/runs/${CI_PIPELINE_ID}/index.html";</script>
      <title>Redirecting…</title>
      <a href="/runs/${CI_PIPELINE_ID}/index.html">Open latest report</a>
      EOF

    # Rebuild the top-level index.html that lists *all* runs
    - |
      echo "Building public/index.html with links to all runs..."
      {
        echo '<!doctype html>'
        echo '<html><head><meta charset="utf-8"><title>Allure Reports</title>'
        echo '<style>body{font-family:system-ui,Arial;margin:2rem} table{border-collapse:collapse} td,th{padding:.5rem 1rem;border:1px solid #ddd} a{color:#1565c0;text-decoration:none}</style>'
        echo '</head><body>'
        echo '<h1>Allure Reports</h1>'
        echo '<p><a href="latest/">Open Latest ▶</a></p>'
        echo '<table><thead><tr><th>Pipeline ID</th><th>Branch</th><th>Commit</th><th>When</th><th>Link</th></tr></thead><tbody>'
        # list directories under public/runs (sorted newest first)
        for d in $(ls -td public/runs/* 2>/dev/null | sed 's|public/||'); do
          pid=$(basename "$d")
          link="/${d}/index.html"
          # We only know current pipeline’s context as env vars; for older runs we’ll show N/A
          if [ "$pid" = "${CI_PIPELINE_ID}" ]; then
            br="${CI_COMMIT_REF_NAME}"
            sha="${CI_COMMIT_SHORT_SHA}"
            when="${CI_PIPELINE_CREATED_AT}"
          else
            br="N/A"; sha="N/A"; when="N/A"
          fi
          printf '<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td><a href="%s">Open</a></td></tr>\n' "$pid" "$br" "$sha" "$when" "$link"
        done
        echo '</tbody></table>'
        echo '</body></html>'
      } > public/index.html
  artifacts:
    paths:
      - public
    expire_in: 2 weeks

# 2) Publish to GitLab Pages
pages:
  stage: pages
  dependencies:
    - build-allure
  script:
    - echo "Publishing GitLab Pages..."
  artifacts:
    paths:
      - public
  only:
    - main
